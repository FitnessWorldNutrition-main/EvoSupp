{{- 'product-grid.css' | asset_url | stylesheet_tag -}}
{{- 'scroll-navigation.css' | asset_url | stylesheet_tag -}}
{%- liquid
	assign section_heading = section.settings.heading
	assign section_description = section.settings.description
	assign product_limit = section.settings.product_limit
	assign columns_desktop = section.settings.columns_desktop
	assign mobile_swipe = section.settings.mobile_swipe

	assign disable_top_spacing = section.settings.disable_top_spacing
	assign disable_bottom_spacing = section.settings.disable_bottom_spacing
	assign product_id = product.id
	if template contains 'cart' and cart != empty
		assign product_id = cart.items[0].product_id
	endif

	assign columns_class = 'small-6 medium-6 large-4'
	case columns_desktop
		when 2
			assign columns_class = 'small-6 medium-6'
		when 3
			assign columns_class = 'small-6 medium-4'
		when 4
			assign columns_class = 'small-6 medium-6 large-3'
		when 5
			assign columns_class = 'small-6 medium-3 large-1/5'
		when 6
			assign columns_class = 'small-6 medium-3 large-2'
	endcase
-%}
<div class="row">
	<div class="small-12 columns">
		<product-recommendations class="product-recommendations{% if mobile_swipe %} swipe-on-mobile{% endif %} section-spacing-padding{% if disable_top_spacing %} section-spacing--disable-top{% endif %}{% if disable_bottom_spacing %} section-spacing--disable-bottom{% endif %}" data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&product_id={{ product_id }}&limit={{ product_limit }}">
			{% if recommendations.performed and recommendations.products_count > 0 %}
				{% render 'section-header', section_heading: section_heading, section_description: section_description %}
				<div data-scroll-nav>
					<ul class="products row no-padding" data-scroll-container>
						{% for recommendation in recommendations.products %}
							<li class="{{ columns_class }} columns">
								{% render 'product-card', product_card_product: recommendation %}
							</li>
						{% endfor %}
					</ul>
					{%- if recommendations.products_count > 2 -%}
						<div class="flickity-nav flickity-prev" tabindex="0" data-scroll-prev>
							{% render 'svg-icons' with 'carousel-prev' %}
						</div>
						<div class="flickity-nav flickity-next" tabindex="0" data-scroll-next>
							{% render 'svg-icons' with 'carousel-next' %}
						</div>
					{%- endif -%}
				</div>
			{% endif %}
		</product-recommendations>
	</div>
</div>
<script>
  // Initialize scroll navigation for product recommendations
  (function() {
    function initScrollNav() {
      const wrapper = document.querySelector('.product-recommendations [data-scroll-nav]');
      if (!wrapper) return;
      
      const container = wrapper.querySelector('[data-scroll-container]');
      const prevBtn = wrapper.querySelector('[data-scroll-prev]');
      const nextBtn = wrapper.querySelector('[data-scroll-next]');
      
      if (!container || !prevBtn || !nextBtn) return;
      
      function getScrollAmount() {
        // Scroll by one product width
        const firstItem = container.querySelector('.columns');
        if (firstItem) {
          return firstItem.offsetWidth;
        }
        return container.offsetWidth / 2;
      }
      
      function updateButtons() {
        const isAtStart = container.scrollLeft <= 0;
        const isAtEnd = container.scrollLeft >= container.scrollWidth - container.offsetWidth - 10;
        
        prevBtn.classList.toggle('disabled', isAtStart);
        nextBtn.classList.toggle('disabled', isAtEnd);
      }
      
      function scrollPrev(e) {
        e.preventDefault();
        e.stopPropagation();
        container.scrollBy({
          left: -getScrollAmount(),
          behavior: 'smooth'
        });
      }
      
      function scrollNext(e) {
        e.preventDefault();
        e.stopPropagation();
        container.scrollBy({
          left: getScrollAmount(),
          behavior: 'smooth'
        });
      }
      
      prevBtn.addEventListener('click', scrollPrev);
      nextBtn.addEventListener('click', scrollNext);
      container.addEventListener('scroll', updateButtons, { passive: true });
      
      updateButtons();
    }
    
    // Try to initialize immediately
    if (document.readyState === 'complete') {
      setTimeout(initScrollNav, 100);
    } else {
      document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initScrollNav, 100);
      });
    }
    
    // Also listen for content being loaded dynamically
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.addedNodes.length) {
          setTimeout(initScrollNav, 100);
        }
      });
    });
    
    const targetNode = document.querySelector('.product-recommendations');
    if (targetNode) {
      observer.observe(targetNode, { childList: true, subtree: true });
    }
  })();
</script>
{% schema %}
	{
		"name": "Product recommendations",
		"class": "section-product-recommendations",
		"settings": [
		{
			"type": "paragraph",
			"content": "Customize product recommendations with Search and Discovery app. [Learn more](https://help.shopify.com/en/manual/online-store/search-and-discovery/product-recommendations)."
		},
		{
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "You may also like"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description",
      "default": "<p>Describe your featured collection here</p>"
    },
		{
			"type": "checkbox",
			"id": "mobile_swipe",
			"default": true,
			"label": "Enable swipe on mobile"
		},
		{
			"type": "range",
			"id": "product_limit",
			"min": 2,
			"max": 6,
			"step": 1,
			"label": "Maximum products to show",
			"default": 4
		},
		{
			"type": "range",
			"id": "columns_desktop",
			"min": 2,
			"max": 6,
			"step": 1,
			"default": 4,
			"label": "Number of columns on desktop"
		},
 		{
       "type": "header",
       "content": "Spacing"
     },
 		{
 			"type": "checkbox",
 			"id": "disable_top_spacing",
 			"default": false,
 			"label": "Remove top spacing"
 		},
 		{
 			"type": "checkbox",
 			"id": "disable_bottom_spacing",
 			"default": false,
 			"label": "Remove bottom spacing"
 		}
		]
	}
{% endschema %}
