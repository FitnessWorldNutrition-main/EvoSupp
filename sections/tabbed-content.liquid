{{- 'tabbed-content.css' | asset_url | stylesheet_tag -}}
<script src="{{ 'tabbed-content.js' | asset_url }}" defer="defer"></script>
{%- liquid
	assign section_heading = section.settings.heading
	assign marker_style = section.settings.marker_style
	assign section_description = section.settings.description

	assign text_size = section.settings.text_size
	assign tab_alignment = section.settings.tab_alignment
	assign text_alignment = section.settings.text_alignment

	assign marker_color = section.settings.marker_color
	assign color_text = section.settings.color_text
	assign color_tabs = section.settings.color_tabs

	assign disable_top_spacing = section.settings.disable_top_spacing
	assign disable_bottom_spacing = section.settings.disable_bottom_spacing

	assign color_bg = section.settings.color_bg | downcase
	assign color_body_bg = settings.color_body_bg | downcase

	assign has_bg = true
	if color_body_bg == color_bg or color_bg == 'transparent' or color_bg == 'rgba(0,0,0,0)'
		assign has_bg = false
	endif
-%}
<div class="row">
	<div class="small-12 columns">
		<div class="tabbed-content-wrapper {% if has_bg -%}tabbed-content--has-bg{% endif %} section-spacing{% if disable_top_spacing %} section-spacing--disable-top{% endif %}{% if disable_bottom_spacing %} section-spacing--disable-bottom{% endif %}" style="--color-bg: {{ color_bg }}; --bg-body-rgb: {{ color_bg.rgb | replace: ' ' , ',' }}; --color-body: {{ color_text }}; --color-tabs: {{ color_tabs.rgb | replace: ' ' , ',' }};">
			{% render 'section-header', section_heading: section_heading, section_description: section_description, marker_color: marker_color, marker_style: marker_style %}
			<tabbed-content class="tabbed-content tabs-{{ tab_alignment }} text-size--{{ text_size }}" selected-index="0">
				{% comment %} <scroll-shadow class="tabbed-content--scroll">
					<div class="tabbed-content--tabs tabs-{{ tab_alignment }}">
						{%- for block in section.blocks -%}
						<button class="{% if forloop.index == 1 %} active{%- endif -%}" {{ block.shopify_attributes }}>{% render 'svg-icons-inline', icon: block.settings.icon %} {{ block.settings.tab_label }}</button>
						{%- endfor -%}
					</div>
				</scroll-shadow> {% endcomment %}
				{%- for block in section.blocks -%}
					<div class="tabbed-content--content text-{{ text_alignment }}{% if forloop.index == 1 %} active{%- endif -%}" style="--columns: {{ block.settings.text_columns }};" data-block-id="{{ block.id }}">
						{%- if block.type == 'specification' -%}
							{%- render 'product-specification-table', block: block -%}
						{%- elsif block.type == 'tab' and block.settings.show_summary -%}
							<div class="description-with-summary">
								<div class="description-summary" id="description-summary-{{ block.id }}">
									<style>
										.description-summary-{{ block.id }} {
											background-color: {{ block.settings.summary_background_color | default: 'transparent' }};
											border: {{ block.settings.summary_border_width | default: 0 }}px solid {{ block.settings.summary_border_color | default: '#e0e0e0' }};
											border-radius: {{ block.settings.summary_border_radius | default: 0 }}px;
											padding: {{ block.settings.summary_padding | default: 0 }}px;
											position: sticky;
											top: 20px;
											max-height: calc(100vh - 100px);
											overflow-y: auto;
										}
										
										.description-summary-{{ block.id }} .summary-title {
											color: {{ block.settings.summary_title_color | default: '#000' }};
											font-size: {{ block.settings.summary_title_font_size | default: 24 }}px;
											font-weight: 900;
											margin-bottom: 20px;
											text-transform: uppercase;
											letter-spacing: 0.5px;
											font-family: Prompt;
											font-weight: 900;
										}

										@media only screen and (max-width: 768px) {
											.description-summary-{{ block.id }} .summary-title {
												margin-bottom: 0px;
											}
										}
										
										.description-summary-{{ block.id }} .summary-list {
											list-style: none;
											padding: 0;
											margin: 0;
										}
										
										.description-summary-{{ block.id }} .summary-item {
											margin-bottom: 0;
										}
										
										.description-summary-{{ block.id }} .summary-link {
											color: {{ block.settings.summary_text_color | default: '#FF6B35' }};
											text-decoration: none;
											display: block;
											padding: 12px 0;
											transition: all 0.3s ease;
											font-size: {{ block.settings.summary_list_font_size | default: 15 }}px;
											font-weight: 400;
											line-height: 1.4;
										}
										
										.description-summary-{{ block.id }} .summary-separator {
											height: 1px;
											width: 100%;
											background-color: {{ block.settings.summary_border_color | default: '#e0e0e0' }};
											box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.17);
											margin-bottom: 0;
										}
										
										.description-summary-{{ block.id }} .summary-link:hover {
											color: {{ block.settings.summary_hover_color | default: '#e4f966' }};
											padding-left: 5px;
										}
										
										.description-summary-{{ block.id }} .summary-link.level-3 {
											padding-left: 20px;
											font-size: {{ block.settings.summary_list_font_size | default: 15 | minus: 1 }}px;
										}
										
										.description-summary-{{ block.id }} .summary-link.level-3:hover {
											padding-left: 25px;
										}
										
										.description-summary-{{ block.id }} .summary-link.level-4 {
											padding-left: 40px;
											font-size: {{ block.settings.summary_list_font_size | default: 15 | minus: 2 }}px;
										}
										
										.description-summary-{{ block.id }} .summary-link.level-4:hover {
											padding-left: 45px;
										}
										
										.description-with-summary {
											display: grid;
											grid-template-columns: 450px 1fr;
											gap: 2rem;
											align-items: start;
										}
										
										@media screen and (max-width: 968px) {
											.description-with-summary {
												grid-template-columns: 1fr;
												gap: 1.5rem;
											}
											
											.description-summary {
												order: -1;
											}
											
											.description-summary-{{ block.id }} {
												position: static !important;
												max-height: none !important;
											}
										}
									</style>
									
									<div class="description-summary-{{ block.id }}">
										<div class="summary-title">{{ block.settings.summary_title | default: 'Sommaire' }}</div>
										<ul class="summary-list" id="summary-list-{{ block.id }}">
											<!-- Summary items will be populated by JavaScript -->
										</ul>
									</div>
								</div>
								<div class="description-content" id="description-content-{{ block.id }}">
						{{ block.settings.text | newline_to_br }}
						{{ block.settings.page.content }}
						{{ block.settings.custom_liquid }}
								</div>
							</div>
							
							<script>
								(function() {
									const summaryList = document.getElementById('summary-list-{{ block.id }}');
									const descriptionContent = document.getElementById('description-content-{{ block.id }}');
									const summaryContainer = document.getElementById('description-summary-{{ block.id }}');
									const summaryWrapper = summaryContainer ? summaryContainer.closest('.description-with-summary') : null;
									
									if (summaryList && descriptionContent) {
										function generateSummary() {
											const headings = descriptionContent.querySelectorAll('h2, h3, h4');
											summaryList.innerHTML = '';
											
											if (headings.length > 0) {
												let headingCounter = 0;
												headings.forEach(function(heading, index) {
													headingCounter++;
													
													// Create unique ID for each heading if it doesn't have one
													if (!heading.id) {
														heading.id = 'heading-{{ block.id }}-' + headingCounter;
													}
													
													// Create summary item
													const listItem = document.createElement('li');
													listItem.className = 'summary-item';
													
													const link = document.createElement('a');
													link.href = '#' + heading.id;
													link.className = 'summary-link';
													link.textContent = heading.textContent.trim();
													
													// Add level class for hierarchy
													const tagName = heading.tagName.toLowerCase();
													if (tagName === 'h3') {
														link.classList.add('level-3');
													} else if (tagName === 'h4') {
														link.classList.add('level-4');
													}
													
													// Add smooth scrolling behavior
													link.addEventListener('click', function(e) {
														e.preventDefault();
														const targetElement = document.getElementById(heading.id);
														if (targetElement) {
															targetElement.scrollIntoView({
																behavior: 'smooth',
																block: 'start'
															});
														}
													});
													
													listItem.appendChild(link);
													
													// Add separator after each link
													const separator = document.createElement('div');
													separator.className = 'summary-separator';
													listItem.appendChild(separator);
													
													summaryList.appendChild(listItem);
												});
											} else {
												// Hide the entire summary container if no headings found
												if (summaryContainer) {
													summaryContainer.style.display = 'none';
												}
												// Make description full width
												if (summaryWrapper) {
													summaryWrapper.style.display = 'block';
												}
											}
										}
										
										// Generate summary on load
										setTimeout(generateSummary, 100);
										
										// Regenerate summary when tab becomes active
										const tabContent = descriptionContent.closest('.tabbed-content--content');
										if (tabContent) {
											const observer = new MutationObserver(function(mutations) {
												mutations.forEach(function(mutation) {
													if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
														if (tabContent.classList.contains('active')) {
															setTimeout(generateSummary, 100);
														}
													}
												});
											});
											
											observer.observe(tabContent, {
												attributes: true,
												attributeFilter: ['class']
											});
										}
									}
								})();
							</script>
						{%- else -%}
							{{ block.settings.text | newline_to_br }}
							{{ block.settings.page.content }}
							{{ block.settings.custom_liquid }}
						{%- endif -%}
					</div>
				{%- endfor -%}
			</tabbed-content>
		</div>
	</div>
</div>

{% schema %}
  {
    "name": "Tabbed content",
		"class": "section-tabbed-content",
    "settings": [
			{
				"type": "text",
				"id": "heading",
				"label": "Heading",
				"default": "Tabbed content",
				"info": "Wrap your text between | to add animated markers. For example: Animated |marker| will underline marker text."
			},
			{
				"type": "select",
				"id": "marker_style",
				"options": [
					{
						"value": "style1",
						"label": "Basic"
					},
					{
						"value": "style2",
						"label": "Double"
					},
					{
						"value": "style3",
						"label": "Squiggle"
					},
					{
						"value": "style4",
						"label": "Zigzag"
					}
				],
				"default": "style1",
				"label": "Marker"
			},
			{
				"type": "richtext",
				"id": "description",
				"label": "Description",
				"default": "<p>Add a short description for this section</p>"
			},
			{
				"type": "select",
				"id": "text_size",
				"label": "Text size",
				"options": [
					{
						"value": "small",
						"label": "Small"
					},
					{
						"value": "regular",
						"label": "Regular"
					},
					{
						"value": "large",
						"label": "Large"
					}
				],
				"default": "regular"
			},
			{
				"type": "select",
				"id": "tab_alignment",
				"label": "Tab alignment",
				"options": [
					{
						"value": "left",
						"label": "Left"
					},
					{
						"value": "center",
						"label": "Center"
					},
					{
						"value": "right",
						"label": "Right"
					}
				],
				"default": "left"
			},
			{
				"type": "select",
				"id": "text_alignment",
				"label": "Content alignment",
				"options": [
					{
						"value": "left",
						"label": "Left"
					},
					{
						"value": "center",
						"label": "Center"
					},
					{
						"value": "right",
						"label": "Right"
					}
				],
				"default": "left"
			},
			{
	      "type": "header",
	      "content": "Colors"
	    },
			{
        "type": "color",
        "id": "color_bg",
        "label": "Background",
        "default": "transparent"
      },
			{
        "type": "color",
        "id": "color_tabs",
        "label": "Tabs",
        "default": "#2c2d2e"
      },
			{
        "type": "color",
        "id": "color_text",
        "label": "Text",
        "default": "#2c2d2e"
      },
			{
				"type": "color",
				"id": "marker_color",
				"label": "Marker",
				"default": "#FD6262"
			},
			{
	      "type": "header",
	      "content": "Spacing"
	    },
			{
				"type": "checkbox",
				"id": "disable_top_spacing",
				"default": false,
				"label": "Remove top spacing"
			},
			{
				"type": "checkbox",
				"id": "disable_bottom_spacing",
				"default": false,
				"label": "Remove bottom spacing"
			}
    ],
    "blocks": [
      {
        "type": "tab",
        "name": "Tab",
        "settings": [
					{
						"type": "header",
						"content": "Table of Contents"
					},
					{
						"type": "checkbox",
						"id": "show_summary",
						"label": "Show table of contents",
						"default": false,
						"info": "Automatically generates a table of contents from H2, H3, and H4 headings in the content. H3 will be nested under H2, and H4 will be nested under H3."
					},
					{
						"type": "text",
						"id": "summary_title",
						"label": "Summary title",
						"default": "Sommaire"
					},
					{
						"type": "header",
						"content": "Summary Styling"
					},
					{
						"type": "color",
						"id": "summary_background_color",
						"label": "Summary background",
						"default": "transparent"
					},
					{
						"type": "color",
						"id": "summary_text_color",
						"label": "Summary link color",
						"default": "#FF6B35"
					},
					{
						"type": "color",
						"id": "summary_title_color",
						"label": "Summary title color",
						"default": "#000000"
					},
					{
						"type": "color",
						"id": "summary_border_color",
						"label": "Summary separator color",
						"default": "#e0e0e0"
					},
					{
						"type": "color",
						"id": "summary_hover_color",
						"label": "Summary hover color",
						"default": "#e4f966"
					},
					{
						"type": "range",
						"id": "summary_border_width",
						"label": "Summary container border width",
						"min": 0,
						"max": 5,
						"step": 1,
						"unit": "px",
						"default": 0
					},
					{
						"type": "range",
						"id": "summary_border_radius",
						"label": "Summary container border radius",
						"min": 0,
						"max": 20,
						"step": 1,
						"unit": "px",
						"default": 0
					},
					{
						"type": "range",
						"id": "summary_padding",
						"label": "Summary container padding",
						"min": 0,
						"max": 40,
						"step": 5,
						"unit": "px",
						"default": 0
					},
					{
						"type": "range",
						"id": "summary_title_font_size",
						"label": "Summary title font size",
						"min": 16,
						"max": 32,
						"step": 1,
						"unit": "px",
						"default": 24
					},
					{
						"type": "range",
						"id": "summary_list_font_size",
						"label": "Summary list font size",
						"min": 12,
						"max": 20,
						"step": 1,
						"unit": "px",
						"default": 15
					},
					{
						"type": "header",
						"content": "Tab Settings"
					},
					{
						"type": "text",
						"id": "tab_label",
						"default": "Tab label",
						"label": "Label"
					},
					{
						"type": "select",
						"id": "icon",
						"options": [
							{
								"value": "none",
								"label": "None"
							},
							{
								"value": "apple",
								"label": "Apple"
							},
							{
								"value": "banana",
								"label": "Banana"
							},
							{
								"value": "bottle",
								"label": "Bottle"
							},
							{
								"value": "box",
								"label": "Box"
							},
							{
								"value": "carrot",
								"label": "Carrot"
							},
							{
								"value": "chat_bubble",
								"label": "Chat bubble"
							},
							{
								"value": "check_mark",
								"label": "Check mark"
							},
							{
								"value": "clipboard",
								"label": "Clipboard"
							},
							{
								"value": "dairy",
								"label": "Dairy"
							},
							{
								"value": "dairy_free",
								"label": "Dairy free"
							},
							{
								"value": "dryer",
								"label": "Dryer"
							},
							{
								"value": "eye",
								"label": "Eye"
							},
							{
								"value": "fire",
								"label": "Fire"
							},
							{
								"value": "gluten_free",
								"label": "Gluten free"
							},
							{
								"value": "heart",
								"label": "Heart"
							},
							{
								"value": "iron",
								"label": "Iron"
							},
							{
								"value": "leaf",
								"label": "Leaf"
							},
							{
								"value": "leather",
								"label": "Leather"
							},
							{
								"value": "lightning_bolt",
								"label": "Lightning bolt"
							},
							{
								"value": "lipstick",
								"label": "Lipstick"
							},
							{
								"value": "lock",
								"label": "Lock"
							},
							{
								"value": "map_pin",
								"label": "Map pin"
							},
							{
								"value": "nut_free",
								"label": "Nut free"
							},
							{
								"value": "pants",
								"label": "Pants"
							},
							{
								"value": "paw_print",
								"label": "Paw print"
							},
							{
								"value": "pepper",
								"label": "Pepper"
							},
							{
								"value": "perfume",
								"label": "Perfume"
							},
							{
								"value": "plane",
								"label": "Plane"
							},
							{
								"value": "plant",
								"label": "Plant"
							},
							{
								"value": "price_tag",
								"label": "Price tag"
							},
							{
								"value": "question_mark",
								"label": "Question mark"
							},
							{
								"value": "recycle",
								"label": "Recycle"
							},
							{
								"value": "return",
								"label": "Return"
							},
							{
								"value": "ruler",
								"label": "Ruler"
							},
							{
								"value": "serving_dish",
								"label": "Serving dish"
							},
							{
								"value": "shirt",
								"label": "Shirt"
							},
							{
								"value": "shoe",
								"label": "Shoe"
							},
							{
								"value": "silhouette",
								"label": "Silhouette"
							},
							{
								"value": "snowflake",
								"label": "Snowflake"
							},
							{
								"value": "star",
								"label": "Star"
							},
							{
								"value": "stopwatch",
								"label": "Stopwatch"
							},
							{
								"value": "truck",
								"label": "Truck"
							},
							{
								"value": "washing",
								"label": "Washing"
							}
						],
						"default": "none",
						"label": "Icon"
					},
					{
		        "type": "richtext",
		        "id": "text",
		        "label": "Text",
		        "default": "<p>Add a short description for this tabbed section</p>"
		      },
					{
						"type": "select",
						"id": "text_columns",
						"label": "Desktop columns",
						"options": [
							{
								"value": "1",
								"label": "One column"
							},
							{
								"value": "2",
								"label": "Two columns"
							},
							{
								"value": "3",
								"label": "Three columns"
							}
						],
						"default": "1"
					},
	        {
	          "type": "page",
		        "id": "page",
	          "label": "Tab content from page"
	        },
					{
						"type": "liquid",
						"id": "custom_liquid",
						"label": "Custom liquid",
						"info": "Add app snippets or other Liquid code to create advanced customizations. For product description, you can use {{ product.description }}"
					}
        ]
      },
			{
        "type": "specification",
        "name": "Specifications",
				"limit": 1,
        "settings": [
					{
						"type": "text",
						"id": "tab_label",
						"default": "Specifications",
						"label": "Label"
					},
					{
						"type": "select",
						"id": "icon",
						"options": [
							{
								"value": "none",
								"label": "None"
							},
							{
								"value": "apple",
								"label": "Apple"
							},
							{
								"value": "banana",
								"label": "Banana"
							},
							{
								"value": "bottle",
								"label": "Bottle"
							},
							{
								"value": "box",
								"label": "Box"
							},
							{
								"value": "carrot",
								"label": "Carrot"
							},
							{
								"value": "chat_bubble",
								"label": "Chat bubble"
							},
							{
								"value": "check_mark",
								"label": "Check mark"
							},
							{
								"value": "clipboard",
								"label": "Clipboard"
							},
							{
								"value": "dairy",
								"label": "Dairy"
							},
							{
								"value": "dairy_free",
								"label": "Dairy free"
							},
							{
								"value": "dryer",
								"label": "Dryer"
							},
							{
								"value": "eye",
								"label": "Eye"
							},
							{
								"value": "fire",
								"label": "Fire"
							},
							{
								"value": "gluten_free",
								"label": "Gluten free"
							},
							{
								"value": "heart",
								"label": "Heart"
							},
							{
								"value": "iron",
								"label": "Iron"
							},
							{
								"value": "leaf",
								"label": "Leaf"
							},
							{
								"value": "leather",
								"label": "Leather"
							},
							{
								"value": "lightning_bolt",
								"label": "Lightning bolt"
							},
							{
								"value": "lipstick",
								"label": "Lipstick"
							},
							{
								"value": "lock",
								"label": "Lock"
							},
							{
								"value": "map_pin",
								"label": "Map pin"
							},
							{
								"value": "nut_free",
								"label": "Nut free"
							},
							{
								"value": "pants",
								"label": "Pants"
							},
							{
								"value": "paw_print",
								"label": "Paw print"
							},
							{
								"value": "pepper",
								"label": "Pepper"
							},
							{
								"value": "perfume",
								"label": "Perfume"
							},
							{
								"value": "plane",
								"label": "Plane"
							},
							{
								"value": "plant",
								"label": "Plant"
							},
							{
								"value": "price_tag",
								"label": "Price tag"
							},
							{
								"value": "question_mark",
								"label": "Question mark"
							},
							{
								"value": "recycle",
								"label": "Recycle"
							},
							{
								"value": "return",
								"label": "Return"
							},
							{
								"value": "ruler",
								"label": "Ruler"
							},
							{
								"value": "serving_dish",
								"label": "Serving dish"
							},
							{
								"value": "shirt",
								"label": "Shirt"
							},
							{
								"value": "shoe",
								"label": "Shoe"
							},
							{
								"value": "silhouette",
								"label": "Silhouette"
							},
							{
								"value": "snowflake",
								"label": "Snowflake"
							},
							{
								"value": "star",
								"label": "Star"
							},
							{
								"value": "stopwatch",
								"label": "Stopwatch"
							},
							{
								"value": "truck",
								"label": "Truck"
							},
							{
								"value": "washing",
								"label": "Washing"
							}
						],
						"default": "none",
						"label": "Icon"
					},
					{
						"type": "textarea",
						"id": "content",
						"label": "Metafields",
						"info": "Include a list of labels and product metafield keys below, separated by a colon, one per line. Example: Color:custom.color"
					},
					{
						"type": "text",
						"id": "empty_field_label",
						"default": "N/A",
						"label": "Empty field text",
						"info": "Text to use for empty fields"
					}
        ]
      }
    ],
    "presets": [
      {
        "name": "Tabbed content",
				"blocks": [
					{
						"type": "tab"
					},
					{
						"type": "tab"
					},
					{
						"type": "tab"
					}
				]
      }
    ],
		"enabled_on": {
			"templates": ["*"],
			"groups": [
				"header", "footer"
			]
		}
  }
{% endschema %}
